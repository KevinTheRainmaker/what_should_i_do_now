<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>What should I do now?</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .progress-bar {
            transition: width 0.3s ease;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8 max-w-md">
        <!-- í—¤ë” -->
        <div class="text-center mb-8">
            <h1 class="text-2xl font-bold text-gray-800 mb-2">What should I do now?</h1>
            <p class="text-gray-600">ì—¬í–‰ìë¥¼ ìœ„í•œ í‚¬ë§íƒ€ì„ ì¶”ì²œ ì„œë¹„ìŠ¤</p>
            <div class="text-sm text-gray-500 mt-2">
                ğŸ“ {CURRENT_LOCATION} Â· {CURRENT_WEATHER}
            </div>
        </div>

        <!-- ê¸°ì¡´ ì…ë ¥ í¼ -->
        <div id="input-form" class="bg-white rounded-lg shadow-md p-6 mb-6">
            <form id="preferences-form">
                <!-- ì‹œê°„ ì„ íƒ -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-3">ë‚¨ëŠ” ì‹œê°„ì´ ì–¼ë§ˆë‚˜ ë˜ì‹œë‚˜ìš”?</label>
                    <div class="grid grid-cols-2 gap-2">
                        <button type="button" class="time-btn p-3 border-2 border-gray-200 rounded-lg text-sm hover:border-blue-500 hover:bg-blue-50" data-value="â‰¤30">30ë¶„ ì´í•˜</button>
                        <button type="button" class="time-btn p-3 border-2 border-gray-200 rounded-lg text-sm hover:border-blue-500 hover:bg-blue-50" data-value="30-60">30ë¶„~1ì‹œê°„</button>
                        <button type="button" class="time-btn p-3 border-2 border-gray-200 rounded-lg text-sm hover:border-blue-500 hover:bg-blue-50" data-value="60-120">1~2ì‹œê°„</button>
                        <button type="button" class="time-btn p-3 border-2 border-gray-200 rounded-lg text-sm hover:border-blue-500 hover:bg-blue-50" data-value=">120">2ì‹œê°„ ì´ìƒ</button>
                    </div>
                </div>

                <!-- ì˜ˆì‚° ì„ íƒ -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-3">ì˜ˆì‚°ì€ ì–´ëŠ ì •ë„ë¡œ ìƒê°í•˜ì‹œë‚˜ìš”?</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button type="button" class="budget-btn p-3 border-2 border-gray-200 rounded-lg text-sm hover:border-blue-500 hover:bg-blue-50" data-value="low">ë‚®ìŒ</button>
                        <button type="button" class="budget-btn p-3 border-2 border-gray-200 rounded-lg text-sm hover:border-blue-500 hover:bg-blue-50" data-value="mid">ì¤‘ê°„</button>
                        <button type="button" class="budget-btn p-3 border-2 border-gray-200 rounded-lg text-sm hover:border-blue-500 hover:bg-blue-50" data-value="high">ë†’ìŒ</button>
                    </div>
                </div>

                 <!-- í…Œë§ˆ ì„ íƒ -->
                 <div class="mb-6">
                     <label class="block text-sm font-medium text-gray-700 mb-3">ì–´ë–¤ ë¶„ìœ„ê¸°ë¥¼ ì›í•˜ì‹œë‚˜ìš”?</label>
                     <div class="grid grid-cols-2 gap-2">
                         <button type="button" class="theme-btn p-3 border-2 border-gray-200 rounded-lg text-sm hover:border-blue-500 hover:bg-blue-50" data-value="relax">íœ´ì‹</button>
                         <button type="button" class="theme-btn p-3 border-2 border-gray-200 rounded-lg text-sm hover:border-blue-500 hover:bg-blue-50" data-value="shopping">ì‡¼í•‘</button>
                         <button type="button" class="theme-btn p-3 border-2 border-gray-200 rounded-lg text-sm hover:border-blue-500 hover:bg-blue-50" data-value="food">ì‹ì‚¬</button>
                         <button type="button" class="theme-btn p-3 border-2 border-gray-200 rounded-lg text-sm hover:border-blue-500 hover:bg-blue-50" data-value="activity">ì•¡í‹°ë¹„í‹°</button>
                     </div>
                 </div>

                <!-- ìì—°ì–´ ì…ë ¥ (AI ì§ˆë¬¸ ì™„ë£Œ í›„ í‘œì‹œ) -->
                <div id="natural-input-section" class="mb-6 hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        ğŸ’¬ AI ì§ˆë¬¸ ë‹µë³€ ìš”ì•½
                    </label>
                    <textarea id="natural-input" 
                              class="w-full p-3 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                              rows="3"
                              placeholder="AI ì§ˆë¬¸ì— ëŒ€í•œ ë‹µë³€ì´ ì—¬ê¸°ì— ìë™ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤..."
                              readonly></textarea>
                    <p class="text-xs text-gray-500 mt-1">
                        ì´ ì •ë³´ëŠ” AIê°€ ìƒì„±í•œ ë§ì¶¤í˜• ì§ˆë¬¸ì— ëŒ€í•œ ë‹µë³€ì…ë‹ˆë‹¤
                    </p>
                </div>

                <!-- ì¶”ì²œ ë²„íŠ¼ -->
                <button type="submit" 
                        class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                    ğŸ¯ ë§ì¶¤ ì¶”ì²œ ë°›ê¸°
                </button>
            </form>
        </div>

        <!-- ì§ˆì˜ì‘ë‹µ ì¸í„°í˜ì´ìŠ¤ (ìˆ¨ê¹€) -->
        <div id="question-interface" class="hidden">
            <!-- Progress Bar -->
            <div class="mb-6">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-medium text-gray-700">AI ì§ˆì˜ì‘ë‹µ ì§„í–‰ë¥ </span>
                    <span id="progress-text" class="text-sm text-gray-500">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div id="progress-bar" class="bg-blue-600 h-2 rounded-full progress-bar" style="width: 0%"></div>
                </div>
            </div>

            <!-- í˜„ì¬ ì§ˆë¬¸ -->
            <div id="current-question" class="bg-white rounded-lg shadow-md p-6 mb-6 fade-in">
                <div class="mb-4">
                    <h3 id="question-text" class="text-lg font-medium text-gray-800 mb-4"></h3>
                    <div class="mb-4">
                        <textarea id="answer-input" 
                                  class="w-full p-3 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                  rows="4"
                                  placeholder="ë‹µë³€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”..."></textarea>
                    </div>
                    <div class="flex justify-between">
                        <button id="back-btn" 
                                class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled>
                            â† ì´ì „ ì§ˆë¬¸
                        </button>
                        <button id="next-btn" 
                                class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed">
                            <span id="next-btn-text">ë‹¤ìŒ ì§ˆë¬¸ â†’</span>
                            <span id="next-btn-loading" class="hidden">
                                <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                ì²˜ë¦¬ ì¤‘...
                            </span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- ì™„ë£Œ í›„ ì¶”ì²œ ìƒì„± -->
            <div id="completion-section" class="hidden bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="text-center">
                    <h3 class="text-lg font-medium text-gray-800 mb-4">âœ… AI ì§ˆì˜ì‘ë‹µì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</h3>
                    <p class="text-gray-600 mb-6">ì´ì œ ë§ì¶¤í˜• ì¶”ì²œì„ ìƒì„±í•©ë‹ˆë‹¤.</p>
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600 mx-auto mb-4"></div>
                    <p class="text-gray-600">ì¶”ì²œì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                </div>
            </div>
        </div>

        <!-- ê²°ê³¼ ì„¹ì…˜ -->
        <div id="results-section" class="hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-medium text-gray-800 mb-4">ì¶”ì²œ ê²°ê³¼</h2>
                <div id="results-content"></div>
            </div>
        </div>

         <!-- ë¡œë”© ì„¹ì…˜ -->
         <div id="loading-section" class="hidden">
             <div class="bg-white rounded-lg shadow-md p-6">
                 <div class="text-center mb-6">
                     <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
                     <h3 class="text-lg font-medium text-gray-800 mb-2">ë§ì¶¤í˜• ì¶”ì²œ ìƒì„± ì¤‘</h3>
                     <p class="text-gray-600">AIê°€ ë‹¹ì‹ ì˜ ì„ í˜¸ë„ì— ë§ëŠ” ì¥ì†Œë¥¼ ì°¾ê³  ìˆìŠµë‹ˆë‹¤...</p>
                 </div>
                 
                 <!-- ì§„í–‰ ë‹¨ê³„ í‘œì‹œ -->
                 <div class="space-y-4">
                     <div id="step-1" class="flex items-center p-3 bg-gray-50 rounded-lg">
                         <div class="w-6 h-6 rounded-full bg-gray-300 flex items-center justify-center mr-3">
                             <span class="text-xs font-medium text-gray-600">1</span>
                         </div>
                         <span class="text-sm text-gray-600">ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™” ì¤‘...</span>
                     </div>
                     
                     <div id="step-2" class="flex items-center p-3 bg-gray-50 rounded-lg">
                         <div class="w-6 h-6 rounded-full bg-gray-300 flex items-center justify-center mr-3">
                             <span class="text-xs font-medium text-gray-600">2</span>
                         </div>
                         <span class="text-sm text-gray-600">ê²€ìƒ‰ ì¿¼ë¦¬ ìƒì„± ì¤‘...</span>
                     </div>
                     
                     <div id="step-3" class="flex items-center p-3 bg-gray-50 rounded-lg">
                         <div class="w-6 h-6 rounded-full bg-gray-300 flex items-center justify-center mr-3">
                             <span class="text-xs font-medium text-gray-600">3</span>
                         </div>
                         <span class="text-sm text-gray-600">ì¥ì†Œ ê²€ìƒ‰ ë° ì •ê·œí™” ì¤‘...</span>
                     </div>
                     
                     <div id="step-4" class="flex items-center p-3 bg-gray-50 rounded-lg">
                         <div class="w-6 h-6 rounded-full bg-gray-300 flex items-center justify-center mr-3">
                             <span class="text-xs font-medium text-gray-600">4</span>
                         </div>
                         <span class="text-sm text-gray-600">ì´ë™ì‹œê°„ ê³„ì‚° ì¤‘...</span>
                     </div>
                     
                     <div id="step-5" class="flex items-center p-3 bg-gray-50 rounded-lg">
                         <div class="w-6 h-6 rounded-full bg-gray-300 flex items-center justify-center mr-3">
                             <span class="text-xs font-medium text-gray-600">5</span>
                         </div>
                         <span class="text-sm text-gray-600">ì‹œê°„ ì í•©ë„ ë¶„ë¥˜ ì¤‘...</span>
                     </div>
                     
                     <div id="step-6" class="flex items-center p-3 bg-gray-50 rounded-lg">
                         <div class="w-6 h-6 rounded-full bg-gray-300 flex items-center justify-center mr-3">
                             <span class="text-xs font-medium text-gray-600">6</span>
                         </div>
                         <span class="text-sm text-gray-600">í™œë™ ë­í‚¹ ë° ì„ ë³„ ì¤‘...</span>
                     </div>
                     
                     <div id="step-7" class="flex items-center p-3 bg-gray-50 rounded-lg">
                         <div class="w-6 h-6 rounded-full bg-gray-300 flex items-center justify-center mr-3">
                             <span class="text-xs font-medium text-gray-600">7</span>
                         </div>
                         <span class="text-sm text-gray-600">LLM í‰ê°€ ë° ì„ ë³„ ì¤‘...</span>
                     </div>
                     
                     <div id="step-8" class="flex items-center p-3 bg-gray-50 rounded-lg">
                         <div class="w-6 h-6 rounded-full bg-gray-300 flex items-center justify-center mr-3">
                             <span class="text-xs font-medium text-gray-600">8</span>
                         </div>
                         <span class="text-sm text-gray-600">ë¦¬ë·° ìˆ˜ì§‘ ë° ìš”ì•½ ì¤‘...</span>
                     </div>
                     
                     <div id="step-9" class="flex items-center p-3 bg-gray-50 rounded-lg">
                         <div class="w-6 h-6 rounded-full bg-gray-300 flex items-center justify-center mr-3">
                             <span class="text-xs font-medium text-gray-600">9</span>
                         </div>
                         <span class="text-sm text-gray-600">ìµœì¢… ì¶”ì²œ ì™„ì„± ì¤‘...</span>
                     </div>
                 </div>
             </div>
         </div>
     </div>

     <!-- ì‚¬ì§„ í™•ëŒ€ ëª¨ë‹¬ -->
     <div id="photo-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center p-4">
         <div class="relative max-w-4xl max-h-full">
             <button onclick="hidePhotoModal()" 
                     class="absolute top-2 right-2 text-white text-2xl font-bold bg-black bg-opacity-50 rounded-full w-8 h-8 flex items-center justify-center hover:bg-opacity-75">
                 Ã—
             </button>
             <img id="modal-photo" src="" alt="" class="max-w-full max-h-full rounded-lg">
             <p id="modal-caption" class="text-white text-center mt-2 text-sm"></p>
         </div>
     </div>

     <script>
        class HybridInterface {
            constructor() {
                this.sessionId = null;
                this.currentQuestion = null;
                this.isCompleted = false;
                this.answers = {};
                this.questionAnswers = {}; // ì§ˆì˜ì‘ë‹µ ê²°ê³¼ ì €ì¥
                this.questions = []; // ì§ˆë¬¸ ì •ë³´ ì €ì¥
                
                this.initializeEventListeners();
            }

            initializeEventListeners() {
                // ê¸°ì¡´ í¼ ì´ë²¤íŠ¸
                document.getElementById('preferences-form').addEventListener('submit', (e) => this.submitForm(e));
                
                // ì‹œê°„/ì˜ˆì‚°/í…Œë§ˆ ì„ íƒ ì´ë²¤íŠ¸
                document.querySelectorAll('.time-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => this.selectOption(e, 'time'));
                });
                document.querySelectorAll('.budget-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => this.selectOption(e, 'budget'));
                });
                document.querySelectorAll('.theme-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => this.selectOption(e, 'theme'));
                });

                // ì§ˆì˜ì‘ë‹µ ì´ë²¤íŠ¸
                document.getElementById('start-questions-btn').addEventListener('click', () => this.startQuestions());
                document.getElementById('next-btn').addEventListener('click', () => this.submitAnswer());
                document.getElementById('back-btn').addEventListener('click', () => this.goBack());
                document.getElementById('back-to-form-btn').addEventListener('click', () => this.backToForm());
            }

            selectOption(event, type) {
                const button = event.target;
                const value = button.dataset.value;
                
                // ê¸°ì¡´ ì„ íƒ í•´ì œ
                document.querySelectorAll(`.${type}-btn`).forEach(btn => {
                    btn.classList.remove('border-blue-500', 'bg-blue-50');
                    btn.classList.add('border-gray-200');
                });
                
                // ìƒˆ ì„ íƒ ì ìš©
                button.classList.remove('border-gray-200');
                button.classList.add('border-blue-500', 'bg-blue-50');
                
                 // ê°’ ì €ì¥
                 if (type === 'theme') {
                     // í…Œë§ˆëŠ” ë‹¨ì¼ ì„ íƒìœ¼ë¡œ ë³€ê²½
                     this[type] = value;
                 } else {
                     this[type] = value;
                 }
            }

            async startQuestions() {
                try {
                    // ì‚¬ìš©ì ì„ íƒ ì •ë³´ ìˆ˜ì§‘
                    const requestData = {
                        time_bucket: this.time || null,
                        budget_level: this.budget || null,
                        themes: this.theme || null
                    };
                    
                    // ë¡œë”© ìƒíƒœ í‘œì‹œ
                    this.showQuestionLoading();
                    
                    const response = await fetch('/api/questions/start', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestData)
                    });
                    
                    const data = await response.json();
                    this.sessionId = data.session_id;
                    this.currentQuestion = data.current_question;
                    this.isCompleted = data.is_completed;
                    
                    // ì§ˆë¬¸ ì •ë³´ ì €ì¥
                    if (data.current_question) {
                        this.questions.push(data.current_question);
                    }
                    
                    this.showQuestionInterface();
                    this.updateProgress(data.progress);
                    this.displayCurrentQuestion();
                    
                } catch (error) {
                    console.error('ì§ˆë¬¸ ì‹œì‘ ì‹¤íŒ¨:', error);
                    alert('ì§ˆë¬¸ì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }
            }

            showQuestionLoading() {
                // ì§ˆë¬¸ ë¡œë”© ì¤‘ í‘œì‹œ
                const questionInterface = document.getElementById('question-interface');
                const currentQuestion = document.getElementById('current-question');
                
                questionInterface.classList.remove('hidden');
                currentQuestion.innerHTML = `
                    <div class="text-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
                        <p class="text-gray-600">AIê°€ ë§ì¶¤í˜• ì§ˆë¬¸ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                    </div>
                `;
            }

            showQuestionInterface() {
                document.getElementById('input-form').classList.add('hidden');
                document.getElementById('question-interface').classList.remove('hidden');
                
                // ì¶”ì²œ ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
                const submitButton = document.querySelector('button[type="submit"]');
                if (submitButton) {
                    submitButton.textContent = 'ğŸ¤– AI ì§ˆë¬¸ ì§„í–‰ ì¤‘...';
                    submitButton.disabled = true;
                }
            }


            getQuestionById(questionId) {
                // ì €ì¥ëœ ì§ˆë¬¸ ì •ë³´ì—ì„œ ì§ˆë¬¸ ë‚´ìš© ì°¾ê¸°
                const question = this.questions.find(q => q.id === questionId);
                return question ? question.question : null;
            }

            displayCurrentQuestion() {
                if (this.currentQuestion) {
                    // ì§ˆë¬¸ ë‚´ìš© ë³µì›
                    const currentQuestionDiv = document.getElementById('current-question');
                    currentQuestionDiv.innerHTML = `
                        <div class="mb-4">
                            <h3 id="question-text" class="text-lg font-medium text-gray-800 mb-4">${this.currentQuestion.question}</h3>
                            <div class="mb-4">
                                <textarea id="answer-input" 
                                          class="w-full p-3 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                          rows="4"
                                          placeholder="ë‹µë³€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”...">${this.answers[this.currentQuestion.id] || ''}</textarea>
                            </div>
                            <div class="flex justify-between">
                                <button id="back-btn" 
                                        class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                                        disabled>
                                    â† ì´ì „ ì§ˆë¬¸
                                </button>
                                <button id="next-btn" 
                                        class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed">
                                    <span id="next-btn-text">ë‹¤ìŒ ì§ˆë¬¸ â†’</span>
                                    <span id="next-btn-loading" class="hidden">
                                        <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        ì²˜ë¦¬ ì¤‘...
                                    </span>
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¬ë“±ë¡
                    document.getElementById('next-btn').addEventListener('click', () => this.submitAnswer());
                    document.getElementById('back-btn').addEventListener('click', () => this.goBack());
                    
                    // í¬ì»¤ìŠ¤ ì„¤ì •
                    document.getElementById('answer-input').focus();
                }
            }

            async submitAnswer() {
                const answer = document.getElementById('answer-input').value.trim();
                if (!answer) {
                    alert('ë‹µë³€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                // ë¡œë”© ìƒíƒœ ì‹œì‘
                this.setNextButtonLoading(true);

                try {
                    const response = await fetch('/api/questions/answer', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            session_id: this.sessionId,
                            question_id: this.currentQuestion.id,
                            answer: answer
                        })
                    });
                    
                    const data = await response.json();
                    this.answers[this.currentQuestion.id] = answer;
                    this.questionAnswers[this.currentQuestion.id] = answer;
                    this.currentQuestion = data.current_question;
                    this.isCompleted = data.is_completed;
                    
                    // ë‹¤ìŒ ì§ˆë¬¸ ì •ë³´ ì €ì¥
                    if (data.current_question) {
                        this.questions.push(data.current_question);
                    }
                    
                    this.updateProgress(data.progress);
                    
                    if (this.isCompleted) {
                        this.showCompletionSection();
                        // ì§ˆë¬¸ ì™„ë£Œ í›„ ë°”ë¡œ ì¶”ì²œ ìƒì„±
                        setTimeout(() => {
                            this.generateRecommendations();
                        }, 1000); // 1ì´ˆ í›„ ì¶”ì²œ ìƒì„±
                    } else {
                        // ì§ˆë¬¸ ì „í™˜ ì‹œ í˜ì´ë“œ íš¨ê³¼
                        this.fadeOutCurrentQuestion(() => {
                            this.displayCurrentQuestion();
                            this.fadeInCurrentQuestion();
                        });
                    }
                    
                } catch (error) {
                    console.error('ë‹µë³€ ì œì¶œ ì‹¤íŒ¨:', error);
                    alert('ë‹µë³€ì„ ì œì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                } finally {
                    // ë¡œë”© ìƒíƒœ ì¢…ë£Œ
                    this.setNextButtonLoading(false);
                }
            }

            setNextButtonLoading(loading) {
                const nextBtn = document.getElementById('next-btn');
                const nextBtnText = document.getElementById('next-btn-text');
                const nextBtnLoading = document.getElementById('next-btn-loading');
                
                if (loading) {
                    nextBtn.disabled = true;
                    nextBtnText.classList.add('hidden');
                    nextBtnLoading.classList.remove('hidden');
                } else {
                    nextBtn.disabled = false;
                    nextBtnText.classList.remove('hidden');
                    nextBtnLoading.classList.add('hidden');
                }
            }

            fadeOutCurrentQuestion(callback) {
                const questionDiv = document.getElementById('current-question');
                questionDiv.style.transition = 'opacity 0.3s ease-out';
                questionDiv.style.opacity = '0';
                
                setTimeout(() => {
                    callback();
                }, 300);
            }

            fadeInCurrentQuestion() {
                const questionDiv = document.getElementById('current-question');
                questionDiv.style.transition = 'opacity 0.3s ease-in';
                questionDiv.style.opacity = '1';
            }

            async generateRecommendations() {
                try {
                    // ì§ˆë¬¸-ì‘ë‹µ í˜ì–´ë¥¼ ìì—°ì–´ ì…ë ¥ì— ì¶”ê°€
                    const naturalInput = document.getElementById('natural-input');
                    let questionAnswerText = "";
                    
                    // ì§ˆë¬¸-ì‘ë‹µ í˜ì–´ë¥¼ ìˆœì„œëŒ€ë¡œ ì •ë ¬í•´ì„œ ì €ì¥
                    const sortedAnswers = Object.entries(this.questionAnswers)
                        .sort((a, b) => a[0].localeCompare(b[0]))
                        .map(([questionId, answer]) => {
                            // ì§ˆë¬¸ IDë¡œ ì§ˆë¬¸ ë‚´ìš© ì°¾ê¸°
                            const question = this.getQuestionById(questionId);
                            return question ? `Q: ${question} A: ${answer}` : `A: ${answer}`;
                        });
                    
                    questionAnswerText = sortedAnswers.join('\n');
                    naturalInput.value = questionAnswerText;
                    
                     // í¼ ë°ì´í„° ìˆ˜ì§‘ (API í˜•ì‹ì— ë§ê²Œ)
                     const formData = {
                         preferences: {
                             time_bucket: this.time || '30-60',
                             budget_level: this.budget || 'mid',
                             themes: this.theme ? [this.theme] : ['relax'],
                             natural_input: questionAnswerText
                         },
                         context_override: null
                     };

                     this.showLoading();
                     
                     // ë‹¨ê³„ë³„ ì§„í–‰ ìƒí™© ì‹œë®¬ë ˆì´ì…˜
                     this.simulateProgress();
                     
                     const response = await fetch('/api/recommend', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData)
                    });
                    
                    const data = await response.json();
                    this.displayResults(data);
                    
                } catch (error) {
                    console.error('ì¶”ì²œ ìƒì„± ì‹¤íŒ¨:', error);
                    alert('ì¶”ì²œì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    this.hideLoading();
                }
            }

            async goBack() {
                try {
                    const response = await fetch(`/api/questions/back?session_id=${this.sessionId}`, {
                        method: 'POST'
                    });
                    
                    const data = await response.json();
                    this.currentQuestion = data.current_question;
                    this.isCompleted = data.is_completed;
                    
                    this.updateProgress(data.progress);
                    this.displayCurrentQuestion();
                    
                    // ë’¤ë¡œ ê°€ê¸° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                    document.getElementById('back-btn').disabled = !data.can_go_back;
                    
                } catch (error) {
                    console.error('ì´ì „ ì§ˆë¬¸ìœ¼ë¡œ ì´ë™ ì‹¤íŒ¨:', error);
                    alert('ì´ì „ ì§ˆë¬¸ìœ¼ë¡œ ì´ë™í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }
            }

            showCompletionSection() {
                document.getElementById('current-question').classList.add('hidden');
                document.getElementById('completion-section').classList.remove('hidden');
            }

            updateProgress(progress) {
                document.getElementById('progress-bar').style.width = `${progress}%`;
                document.getElementById('progress-text').textContent = `${progress}%`;
            }

            async submitForm(event) {
                event.preventDefault();
                
                // AI ì§ˆë¬¸ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìœ¼ë©´ AI ì§ˆë¬¸ë¶€í„° ì‹œì‘
                if (!this.sessionId || !this.isCompleted) {
                    await this.startQuestions();
                    return;
                }
                
                 // í¼ ë°ì´í„° ìˆ˜ì§‘ (API í˜•ì‹ì— ë§ê²Œ)
                 const formData = {
                     preferences: {
                         time_bucket: this.time || '30-60',
                         budget_level: this.budget || 'mid',
                         themes: this.theme ? [this.theme] : ['relax'],
                         natural_input: document.getElementById('natural-input').value || ''
                     },
                     context_override: null
                 };

                 this.showLoading();
                 
                 // ë‹¨ê³„ë³„ ì§„í–‰ ìƒí™© ì‹œë®¬ë ˆì´ì…˜
                 this.simulateProgress();
                 
                 try {
                     const response = await fetch('/api/recommend', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData)
                    });
                    
                    const data = await response.json();
                    this.displayResults(data);
                    
                } catch (error) {
                    console.error('ì¶”ì²œ ìƒì„± ì‹¤íŒ¨:', error);
                    alert('ì¶”ì²œì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    this.hideLoading();
                }
            }

             showLoading() {
                 document.getElementById('input-form').classList.add('hidden');
                 document.getElementById('question-interface').classList.add('hidden');
                 document.getElementById('completion-section').classList.add('hidden');
                 document.getElementById('loading-section').classList.remove('hidden');
                 
                 // ëª¨ë“  ë‹¨ê³„ ì´ˆê¸°í™”
                 this.resetAllSteps();
             }

             resetAllSteps() {
                 for (let i = 1; i <= 9; i++) {
                     const step = document.getElementById(`step-${i}`);
                     const circle = step.querySelector('div');
                     const text = step.querySelector('span:last-child');
                     
                     circle.className = 'w-6 h-6 rounded-full bg-gray-300 flex items-center justify-center mr-3';
                     text.className = 'text-sm text-gray-600';
                 }
             }

             updateStep(stepNumber, status = 'active') {
                 const step = document.getElementById(`step-${stepNumber}`);
                 const circle = step.querySelector('div');
                 const text = step.querySelector('span:last-child');
                 
                 if (status === 'active') {
                     circle.className = 'w-6 h-6 rounded-full bg-blue-600 flex items-center justify-center mr-3';
                     circle.innerHTML = '<div class="animate-spin rounded-full h-3 w-3 border-b-2 border-white"></div>';
                     text.className = 'text-sm text-blue-600 font-medium';
                 } else if (status === 'completed') {
                     circle.className = 'w-6 h-6 rounded-full bg-green-600 flex items-center justify-center mr-3';
                     circle.innerHTML = '<svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>';
                     text.className = 'text-sm text-green-600 font-medium';
                 }
             }

             hideLoading() {
                 document.getElementById('loading-section').classList.add('hidden');
             }

             async simulateProgress() {
                 const steps = [
                     { step: 1, delay: 800, text: 'ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™” ì¤‘...' },
                     { step: 2, delay: 1500, text: 'ê²€ìƒ‰ ì¿¼ë¦¬ ìƒì„± ì¤‘...' },
                     { step: 3, delay: 3000, text: 'ì¥ì†Œ ê²€ìƒ‰ ë° ì •ê·œí™” ì¤‘...' },
                     { step: 4, delay: 2000, text: 'ì´ë™ì‹œê°„ ê³„ì‚° ì¤‘...' },
                     { step: 5, delay: 1500, text: 'ì‹œê°„ ì í•©ë„ ë¶„ë¥˜ ì¤‘...' },
                     { step: 6, delay: 2000, text: 'í™œë™ ë­í‚¹ ë° ì„ ë³„ ì¤‘...' },
                     { step: 7, delay: 2500, text: 'LLM í‰ê°€ ë° ì„ ë³„ ì¤‘...' },
                     { step: 8, delay: 4000, text: 'ë¦¬ë·° ìˆ˜ì§‘ ë° ìš”ì•½ ì¤‘...' },
                     { step: 9, delay: 1000, text: 'ìµœì¢… ì¶”ì²œ ì™„ì„± ì¤‘...' }
                 ];

                 for (const { step, delay, text } of steps) {
                     // í˜„ì¬ ë‹¨ê³„ í™œì„±í™”
                     this.updateStep(step, 'active');
                     
                     // í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
                     const stepElement = document.getElementById(`step-${step}`);
                     const textElement = stepElement.querySelector('span:last-child');
                     textElement.textContent = text;
                     
                     // ì§€ì—° ì‹œê°„ ëŒ€ê¸°
                     await new Promise(resolve => setTimeout(resolve, delay));
                     
                     // ë‹¨ê³„ ì™„ë£Œ í‘œì‹œ
                     this.updateStep(step, 'completed');
                 }
             }

             displayResults(data) {
                 this.hideLoading();
                 document.getElementById('results-section').classList.remove('hidden');
                 
                 // ë””ë²„ê¹…ìš© ì½˜ì†” ì¶œë ¥
                 console.log('ë°›ì€ ë°ì´í„°:', data);
                 data.items.forEach((item, index) => {
                     console.log(`ì•„ì´í…œ ${index + 1}:`, {
                         name: item.name,
                         review_summary: item.review_summary,
                         has_review: !!item.review_summary
                     });
                 });
                 
                 const resultsContent = document.getElementById('results-content');
                 resultsContent.innerHTML = '';
                 
                 // ì„¸ì…˜ ì •ë³´ í‘œì‹œ
                 const sessionInfo = document.createElement('div');
                 sessionInfo.className = 'bg-gray-100 p-3 rounded-lg mb-4 text-xs text-gray-600';
                 resultsContent.appendChild(sessionInfo);
                 
                 console.log('ì „ì²´ ì•„ì´í…œ ë°ì´í„°:', data.items.map(item => ({name: item.name, photos: item.photos?.length || 0})));
                 
                 data.items.forEach((item, index) => {
                     console.log(`ì•„ì´í…œ ${index + 1}: ${item.name}, ì‚¬ì§„ ê°œìˆ˜: ${item.photos?.length || 0}`);
                     const card = document.createElement('div');
                     card.className = 'bg-white rounded-lg shadow-md p-4 hover:shadow-lg transition-shadow';
                     card.innerHTML = `
                         <div class="flex justify-between items-start mb-2">
                             <div class="flex items-center gap-2">
                                 <span class="bg-blue-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-sm font-bold">${index + 1}</span>
                                 <h3 class="font-semibold text-gray-800">${item.name}</h3>
                             </div>
                             <div class="flex gap-1">
                                 ${item.llm_score ? `<span class="bg-purple-100 text-purple-800 px-2 py-1 rounded-full text-xs">AIì¶”ì²œ ${Math.round(item.llm_score)}ì </span>` : ''}
                                 ${item.locale_hints && item.locale_hints.local_vibe ? '<span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs">í˜„ì§€ê°ì„±</span>' : ''}
                             </div>
                         </div>
                         <p class="text-sm text-gray-600 mb-3">${item.reason_text || item.description || 'ì„¤ëª… ì—†ìŒ'}</p>
                         <div class="flex justify-between items-center text-xs text-gray-500 mb-3">
                             <span>${item.rating ? `â­ ${item.rating}/5` : 'í‰ì  ì •ë³´ ì—†ìŒ'}</span>
                             <span>${item.review_count ? `ğŸ‘¥ ${item.review_count.toLocaleString()}ê°œ ë¦¬ë·°` : 'ë¦¬ë·° ì—†ìŒ'}</span>
                             <span>${this.getBudgetText(item.budget_hint, item.category, item.name)}</span>
                         </div>
                         <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4 mb-3 border border-blue-200 shadow-sm">
                             <div class="flex items-center justify-between mb-2">
                                 <div class="flex items-center">
                                     <span class="text-lg">ğŸ’¬</span>
                                     <h4 class="text-sm font-bold text-blue-900 ml-2">ë°©ë¬¸ê° ë¦¬ë·° ìš”ì•½</h4>
                                 </div>
                             </div>
                             ${item.review_summary && item.review_summary.trim() ? `
                                 <p class="text-sm text-blue-800 leading-relaxed">${item.review_summary}</p>
                                 ${item.top_reviews && item.top_reviews.length > 0 ? `
                                     <details class="mt-2">
                                         <summary class="text-xs text-blue-700 cursor-pointer hover:text-blue-900">ì›ë³¸ ë¦¬ë·° ${item.top_reviews.length}ê°œ ë³´ê¸°</summary>
                                         <div class="mt-2 space-y-1">
                                             ${item.top_reviews.map((review, idx) => `
                                                 <div class="text-xs text-gray-700 bg-white p-2 rounded border-l-2 border-blue-300">
                                                     ${idx + 1}. ${review}
                                                 </div>
                                             `).join('')}
                                         </div>
                                     </details>
                                 ` : ''}
                             ` : `
                                 <p class="text-sm text-gray-600 italic">ë¦¬ë·° ì •ë³´ë¥¼ ìˆ˜ì§‘ ì¤‘ì…ë‹ˆë‹¤...</p>
                             `}
                         </div>
                         <!-- êµí†µìˆ˜ë‹¨ë³„ ì´ë™ì‹œê°„ í‘œì‹œ -->
                         ${item.photos && item.photos.length > 0 ? `
                         <div class="border-t pt-3 mb-3">
                             <h4 class="text-sm font-semibold text-gray-700 mb-2">ğŸ“¸ ì‚¬ì§„ (${item.photos.length}ê°œ)</h4>
                             <div class="grid grid-cols-3 gap-2">
                                 ${item.photos.slice(0, 3).map((photo, idx) => `
                                     <div class="relative aspect-square rounded-lg overflow-hidden bg-gray-100 cursor-pointer hover:opacity-80 transition-opacity"
                                          onclick="showPhotoModal('${photo.replace(/'/g, "\\'")}', '${item.name.replace(/'/g, "\\'")}')">
                                         <img src="${photo}" alt="${item.name} ì‚¬ì§„ ${idx + 1}" 
                                              class="w-full h-full object-cover"
                                              onerror="console.log('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:', this.src); this.style.display='none'; this.parentElement.innerHTML='<div class=\\'flex items-center justify-center h-full text-gray-400 text-xs\\'>ì´ë¯¸ì§€<br>ì—†ìŒ</div>'"
                                              onload="console.log('ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µ:', this.src)">
                                     </div>
                                 `).join('')}
                             </div>
                         </div>
                         ` : ''}
                         
                         <div class="border-t pt-3 mb-3">
                             <h4 class="text-sm font-semibold text-gray-700 mb-2">ğŸš— ì´ë™ì‹œê°„</h4>
                             <div class="grid grid-cols-3 gap-2 text-center text-xs">
                                 ${item.walking_time_min ? `
                                     <div class="bg-green-50 border border-green-200 rounded-lg p-2">
                                         <div class="text-green-600 font-semibold">ğŸš¶ ë„ë³´</div>
                                         <div class="text-green-800 font-bold">${item.walking_time_min}ë¶„</div>
                                     </div>
                                 ` : ''}
                                 ${item.driving_time_min ? `
                                     <div class="bg-blue-50 border border-blue-200 rounded-lg p-2">
                                         <div class="text-blue-600 font-semibold">ğŸš— ì°¨ëŸ‰</div>
                                         <div class="text-blue-800 font-bold">${item.driving_time_min}ë¶„</div>
                                     </div>
                                 ` : ''}
                                 ${item.transit_time_min ? `
                                     <div class="bg-orange-50 border border-orange-200 rounded-lg p-2">
                                         <div class="text-orange-600 font-semibold">ğŸš‡ ëŒ€ì¤‘êµí†µ</div>
                                         <div class="text-orange-800 font-bold">${item.transit_time_min}ë¶„</div>
                                     </div>
                                 ` : ''}
                             </div>
                         </div>
                         <a href="${item.directions_link}" target="_blank" 
                            class="block w-full bg-blue-600 text-white text-center py-2 rounded hover:bg-blue-700">
                             ê¸¸ì°¾ê¸°
                         </a>
                     `;
                     resultsContent.appendChild(card);
                 });
             }

             // í—¬í¼ í•¨ìˆ˜ë“¤
             getBudgetText(level, category, name) {
                 const labels = {
                     'low': 'ğŸ’° ì €ë ´',
                     'mid': 'ğŸ’°ğŸ’° ì¤‘ê°„', 
                     'high': 'ğŸ’°ğŸ’°ğŸ’° ë¹„ìŒˆ',
                     'unknown': 'â“ ì˜ˆì‚° ì •ë³´ ì—†ìŒ'
                 };
                 
                 // í™•ì‹¤í•œ ì •ë³´ê°€ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ë°˜í™˜
                 if (level && level !== 'unknown') {
                     return labels[level];
                 }
                 
                 // ì—†ìœ¼ë©´ ì¹´í…Œê³ ë¦¬ë‚˜ ì´ë¦„ ê¸°ë°˜ìœ¼ë¡œ ì¶”ì •
                 const nameText = (name || '').toLowerCase();
                 const categoryText = (category || '').toLowerCase();
                 
                 if (categoryText === 'park' || nameText.includes('park') || nameText.includes('parc')) {
                     return 'ğŸ†“ ë¬´ë£Œ (ì¶”ì •)';
                 } else if (categoryText === 'cafe' || nameText.includes('cafÃ©') || nameText.includes('cafe')) {
                     return 'ğŸ’° ì €ë ´ (ì¶”ì •)';
                 } else if (categoryText === 'restaurant' || nameText.includes('restaurant')) {
                     return 'ğŸ’°ğŸ’° ì¤‘ê°„ (ì¶”ì •)';
                 } else if (categoryText === 'museum' || nameText.includes('museum')) {
                     return 'ğŸ’°ğŸ’° ì¤‘ê°„ (ì¶”ì •)';
                 }
                 
                 return 'â“ ì˜ˆì‚° ì •ë³´ ì—†ìŒ';
             }
             
             showPhotoModal(photoUrl, placeName) {
                 const modal = document.getElementById('photo-modal');
                 const img = document.getElementById('modal-photo');
                 const caption = document.getElementById('modal-caption');
                 
                 img.src = photoUrl;
                 img.alt = placeName + ' ì‚¬ì§„';
                 caption.textContent = placeName;
                 modal.classList.remove('hidden');
                 
                 // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
                 document.addEventListener('keydown', function(e) {
                     if (e.key === 'Escape') {
                         this.hidePhotoModal();
                     }
                 });
             }
             
             hidePhotoModal() {
                 const modal = document.getElementById('photo-modal');
                 modal.classList.add('hidden');
             }
        }

         // ì „ì—­ í•¨ìˆ˜ë“¤
         function showPhotoModal(photoUrl, placeName) {
             const modal = document.getElementById('photo-modal');
             const img = document.getElementById('modal-photo');
             const caption = document.getElementById('modal-caption');
             
             img.src = photoUrl;
             img.alt = placeName + ' ì‚¬ì§„';
             caption.textContent = placeName;
             modal.classList.remove('hidden');
             
             // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
             document.addEventListener('keydown', function(e) {
                 if (e.key === 'Escape') {
                     hidePhotoModal();
                 }
             });
         }
         
         function hidePhotoModal() {
             const modal = document.getElementById('photo-modal');
             modal.classList.add('hidden');
         }

         // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
         document.addEventListener('DOMContentLoaded', () => {
             new HybridInterface();
             
             // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
             document.getElementById('photo-modal').addEventListener('click', function(e) {
                 if (e.target === this) {
                     hidePhotoModal();
                 }
             });
         });
    </script>
</body>
</html>
