<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>What should I do now?</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .progress-bar {
            transition: width 0.3s ease;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8 max-w-2xl">
        <!-- í—¤ë” -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">What should I do now?</h1>
            <p class="text-gray-600">ì—¬í–‰ìë¥¼ ìœ„í•œ í‚¬ë§íƒ€ì„ ì¶”ì²œ ì„œë¹„ìŠ¤</p>
            <div class="text-sm text-gray-500 mt-2">
                ğŸ“ {CURRENT_LOCATION} Â· {CURRENT_WEATHER}
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="mb-8">
            <div class="flex justify-between items-center mb-2">
                <span class="text-sm font-medium text-gray-700">ì§„í–‰ë¥ </span>
                <span id="progress-text" class="text-sm text-gray-500">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div id="progress-bar" class="bg-blue-600 h-2 rounded-full progress-bar" style="width: 0%"></div>
            </div>
        </div>

        <!-- ì§ˆì˜ì‘ë‹µ ì¸í„°í˜ì´ìŠ¤ -->
        <div id="question-interface" class="hidden">
            <!-- í˜„ì¬ ì§ˆë¬¸ -->
            <div id="current-question" class="bg-white rounded-lg shadow-md p-6 mb-6 fade-in">
                <div class="mb-4">
                    <h3 id="question-text" class="text-lg font-medium text-gray-800 mb-4"></h3>
                    <div class="mb-4">
                        <textarea id="answer-input" 
                                  class="w-full p-3 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                  rows="4"
                                  placeholder="ë‹µë³€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”..."></textarea>
                    </div>
                    <div class="flex justify-between">
                        <button id="back-btn" 
                                class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled>
                            â† ì´ì „ ì§ˆë¬¸
                        </button>
                        <button id="next-btn" 
                                class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                            ë‹¤ìŒ ì§ˆë¬¸ â†’
                        </button>
                    </div>
                </div>
            </div>

            <!-- ì™„ë£Œ í›„ ì¶”ì²œ ë²„íŠ¼ -->
            <div id="completion-section" class="hidden bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="text-center">
                    <h3 class="text-lg font-medium text-gray-800 mb-4">ëª¨ë“  ì§ˆë¬¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</h3>
                    <p class="text-gray-600 mb-6">ì´ì œ ë§ì¶¤í˜• ì¶”ì²œì„ ë°›ì•„ë³´ì„¸ìš”.</p>
                    <button id="get-recommendations-btn" 
                            class="w-full bg-green-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                        ğŸ¯ ì¶”ì²œ ë°›ê¸°
                    </button>
                </div>
            </div>
        </div>

        <!-- ì‹œì‘ ë²„íŠ¼ -->
        <div id="start-section" class="text-center">
            <div class="bg-white rounded-lg shadow-md p-8 mb-6">
                <h2 class="text-xl font-medium text-gray-800 mb-4">ë§ì¶¤í˜• ì¶”ì²œì„ ìœ„í•´ ëª‡ ê°€ì§€ ì§ˆë¬¸ì— ë‹µí•´ì£¼ì„¸ìš”</h2>
                <p class="text-gray-600 mb-6">ì´ 3ê°œì˜ ê°„ë‹¨í•œ ì§ˆë¬¸ìœ¼ë¡œ ë” ì •í™•í•œ ì¶”ì²œì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <button id="start-questions-btn" 
                        class="bg-blue-600 text-white py-3 px-6 rounded-lg font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    ì§ˆë¬¸ ì‹œì‘í•˜ê¸°
                </button>
            </div>
        </div>

        <!-- ê²°ê³¼ ì„¹ì…˜ -->
        <div id="results-section" class="hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-medium text-gray-800 mb-4">ì¶”ì²œ ê²°ê³¼</h2>
                <div id="results-content"></div>
            </div>
        </div>

        <!-- ë¡œë”© ì„¹ì…˜ -->
        <div id="loading-section" class="hidden">
            <div class="bg-white rounded-lg shadow-md p-6 text-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
                <p class="text-gray-600">ì¶”ì²œì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
            </div>
        </div>
    </div>

    <script>
        class QuestionInterface {
            constructor() {
                this.sessionId = null;
                this.currentQuestion = null;
                this.isCompleted = false;
                this.answers = {};
                
                this.initializeEventListeners();
            }

            initializeEventListeners() {
                document.getElementById('start-questions-btn').addEventListener('click', () => this.startQuestions());
                document.getElementById('next-btn').addEventListener('click', () => this.submitAnswer());
                document.getElementById('back-btn').addEventListener('click', () => this.goBack());
                document.getElementById('get-recommendations-btn').addEventListener('click', () => this.getRecommendations());
            }

            async startQuestions() {
                try {
                    const response = await fetch('/api/questions/start', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                    
                    const data = await response.json();
                    this.sessionId = data.session_id;
                    this.currentQuestion = data.current_question;
                    this.isCompleted = data.is_completed;
                    
                    this.showQuestionInterface();
                    this.updateProgress(data.progress);
                    this.displayCurrentQuestion();
                    
                } catch (error) {
                    console.error('ì§ˆë¬¸ ì‹œì‘ ì‹¤íŒ¨:', error);
                    alert('ì§ˆë¬¸ì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }
            }

            showQuestionInterface() {
                document.getElementById('start-section').classList.add('hidden');
                document.getElementById('question-interface').classList.remove('hidden');
            }

            displayCurrentQuestion() {
                if (this.currentQuestion) {
                    document.getElementById('question-text').textContent = this.currentQuestion.question;
                    document.getElementById('answer-input').value = this.answers[this.currentQuestion.id] || '';
                    document.getElementById('answer-input').focus();
                }
            }

            async submitAnswer() {
                const answer = document.getElementById('answer-input').value.trim();
                if (!answer) {
                    alert('ë‹µë³€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                try {
                    const response = await fetch('/api/questions/answer', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            session_id: this.sessionId,
                            question_id: this.currentQuestion.id,
                            answer: answer
                        })
                    });
                    
                    const data = await response.json();
                    this.answers[this.currentQuestion.id] = answer;
                    this.currentQuestion = data.current_question;
                    this.isCompleted = data.is_completed;
                    
                    this.updateProgress(data.progress);
                    
                    if (this.isCompleted) {
                        this.showCompletionSection();
                    } else {
                        this.displayCurrentQuestion();
                    }
                    
                } catch (error) {
                    console.error('ë‹µë³€ ì œì¶œ ì‹¤íŒ¨:', error);
                    alert('ë‹µë³€ì„ ì œì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }
            }

            async goBack() {
                try {
                    const response = await fetch(`/api/questions/back?session_id=${this.sessionId}`, {
                        method: 'POST'
                    });
                    
                    const data = await response.json();
                    this.currentQuestion = data.current_question;
                    this.isCompleted = data.is_completed;
                    
                    this.updateProgress(data.progress);
                    this.displayCurrentQuestion();
                    
                    // ë’¤ë¡œ ê°€ê¸° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                    document.getElementById('back-btn').disabled = !data.can_go_back;
                    
                } catch (error) {
                    console.error('ì´ì „ ì§ˆë¬¸ìœ¼ë¡œ ì´ë™ ì‹¤íŒ¨:', error);
                    alert('ì´ì „ ì§ˆë¬¸ìœ¼ë¡œ ì´ë™í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }
            }

            showCompletionSection() {
                document.getElementById('current-question').classList.add('hidden');
                document.getElementById('completion-section').classList.remove('hidden');
            }

            updateProgress(progress) {
                document.getElementById('progress-bar').style.width = `${progress}%`;
                document.getElementById('progress-text').textContent = `${progress}%`;
            }

            async getRecommendations() {
                // ì§ˆì˜ì‘ë‹µ ê²°ê³¼ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¶”ì²œ ìš”ì²­
                this.showLoading();
                
                try {
                    const response = await fetch(`/api/questions/${this.sessionId}/recommend`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                    
                    const data = await response.json();
                    this.displayResults(data);
                    
                } catch (error) {
                    console.error('ì¶”ì²œ ìƒì„± ì‹¤íŒ¨:', error);
                    alert('ì¶”ì²œì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    this.hideLoading();
                }
            }

            convertAnswersToPreferences() {
                // ì§ˆì˜ì‘ë‹µ ê²°ê³¼ë¥¼ ê¸°ì¡´ Preferences í˜•íƒœë¡œ ë³€í™˜
                // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” LLMì„ ì‚¬ìš©í•´ì„œ ë” ì •êµí•˜ê²Œ ë³€í™˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
                return {
                    time_bucket: "30-60", // ê¸°ë³¸ê°’
                    budget_level: "mid",   // ê¸°ë³¸ê°’
                    themes: ["relax"],     // ê¸°ë³¸ê°’
                    natural_input: Object.values(this.answers).join(' ')
                };
            }

            showLoading() {
                document.getElementById('question-interface').classList.add('hidden');
                document.getElementById('loading-section').classList.remove('hidden');
            }

            hideLoading() {
                document.getElementById('loading-section').classList.add('hidden');
            }

            displayResults(data) {
                this.hideLoading();
                document.getElementById('results-section').classList.remove('hidden');
                
                const resultsContent = document.getElementById('results-content');
                resultsContent.innerHTML = '';
                
                if (data.items && data.items.length > 0) {
                    data.items.forEach((item, index) => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'border border-gray-200 rounded-lg p-4 mb-4';
                        itemDiv.innerHTML = `
                            <h3 class="font-medium text-gray-800 mb-2">${index + 1}. ${item.name}</h3>
                            <p class="text-gray-600 text-sm mb-2">${item.description || 'ì„¤ëª… ì—†ìŒ'}</p>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-500">${item.category || 'ì¹´í…Œê³ ë¦¬ ì—†ìŒ'}</span>
                                <span class="text-sm font-medium text-blue-600">${item.total_score || 0}ì </span>
                            </div>
                        `;
                        resultsContent.appendChild(itemDiv);
                    });
                } else {
                    resultsContent.innerHTML = '<p class="text-gray-600">ì¶”ì²œ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                }
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            new QuestionInterface();
        });
    </script>
</body>
</html>
